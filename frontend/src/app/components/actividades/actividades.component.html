<div *ngIf="!isAuthorized" class="flex justify-center items-start mt-8">
    <div class="surface-card border-round shadow-3 p-6 text-center w-full max-w-md">
        <div class="mb-4">
            <i class="pi pi-lock text-6xl text-primary-500" style="font-size: 4em"></i>
        </div>
        <h2 class="text-4xl font-bold text-primary-700 mb-3" style="font-weight: 900">Acceso restringido</h2>
        <p class="text-sm text-color-secondary mb-4">No cuentas con los permisos necesarios para acceder a esta sección del sistema.</p>
    </div>
</div>

<div *ngIf="isAuthorized">
    <p-toast></p-toast>
    <p-toolbar styleClass="mb-6">
        <ng-template #start>
            <p-button label="Nueva Actividad" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
            <p-button severity="secondary" label="Eliminar" icon="pi pi-trash" outlined (onClick)="deleteSelectedActividades()" [disabled]="!selectedActividades || !selectedActividades.length" />
        </ng-template>
    </p-toolbar>

    <p-table
        #dt
        [value]="actividades()"
        [rows]="10"
        [columns]="cols"
        [paginator]="true"
        [globalFilterFields]="['id', 'nombre', 'descripcion', 'fecha', 'hora', 'estado']"
        [tableStyle]="{ 'min-width': '75rem' }"
        [(selection)]="selectedActividades"
        [rowHover]="true"
        dataKey="id"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} actividades"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 20, 30]">
        <ng-template #caption>
            <div class="flex items-center justify-between">
                <h5 class="m-0">Actividades Registradas</h5>
                <p-iconfield>
                    <p-inputicon styleClass="pi pi-search" />
                    <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar por nombre..." />
                </p-iconfield>
            </div>
        </ng-template>

        <ng-template #header>
            <tr>
                <th style="width: 3rem">
                    <p-tableHeaderCheckbox />
                </th>
                <th style="width: 5rem">ID</th>
                <th pSortableColumn="nombre" style="min-width: 12rem">
                    NOMBRE
                    <p-sortIcon field="nombre" />
                </th>
                <th pSortableColumn="descripcion" style="min-width: 12rem">DESCRIPCION</th>
                <th pSortableColumn="fecha" style="min-width: 8rem">FECHA</th>
                <th pSortableColumn="hora" style="min-width: 8rem">HORA</th>
                <th pSortableColumn="estado" style="min-width: 8rem">ESTADO</th>
                <th pSortableColumn="estado" style="min-width: 8rem">INCENTIVOS</th>
                <th pSortableColumn="nombre" style="min-width: 12rem">ID DE USUARIO</th>
                <th pSortableColumn="nombre" style="min-width: 12rem">NOMBRE DE USUARIO</th>
                <th style="min-width: 10rem">ACCIONES</th>
            </tr>
        </ng-template>

        <ng-template #body let-actividad>
            <tr>
                <td style="width: 3rem">
                    <p-tableCheckbox [value]="actividad" />
                </td>
                <td>{{ actividad.id }}</td>
                <td>{{ actividad.nombre }}</td>
                <td>{{ actividad.descripcion }}</td>
                <td>{{ actividad.fecha | date: 'dd/MM/yyyy' }}</td>
                <td>{{ actividad.hora }}</td>
                <td>
                    <p-button
                        (click)="toggleEstado(actividad)"
                        [icon]="actividad.estado ? 'pi pi-check-circle' : 'pi pi-times-circle'"
                        [label]="actividad.estado ? 'Habilitado' : 'Inhabilitado'"
                        [styleClass]="actividad.estado ? 'p-button-success p-button-text p-button-rounded p-button-sm shadow-sm' : 'p-button-danger p-button-text p-button-rounded p-button-sm shadow-sm'">
                    </p-button>
                </td>
                <td style="text-align: center">
                    <p-button icon="pi pi-gift" class="mr-2," [rounded]="true" [outlined]="true" (click)="incentivosactividad(actividad)" />
                </td>
                <td style="text-align: center">{{ actividad.userId }}</td>
                <td>{{ actividad.nombreuser }}</td>
                <td>
                    <p-button icon="pi pi-pen-to-square" class="mr-2" [rounded]="true" [outlined]="true" (click)="editActividad(actividad)" />
                    <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (click)="deleteActividad(actividad)" />
                </td>
            </tr>
        </ng-template>
    </p-table>
    <p-dialog [(visible)]="incentivoDialog" [style]="{ width: '550px' }" [header]="tituloDialog" [modal]="true">
        <div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div *ngFor="let inc of actividad.incentivos" class="flex items-center p-3 surface-card shadow-1 border-round">
                    <img *ngIf="inc.imagenBase64" [src]="inc.imagenBase64" [alt]="inc.nombre" class="w-8 h-8 mr-3 border-round shadow-1" />
                    <div>
                        <div class="font-medium">{{ inc.nombre }}</div>
                        <div class="text-sm text-color-secondary">{{ inc.descripcion }}</div>
                        <div class="text-xs mt-1 font-bold">Cantidad: {{ inc.cantidad }}</div>
                    </div>
                </div>
            </div>
        </div>
    </p-dialog>
    <p-dialog [(visible)]="actividadDialog" [style]="{ width: '550px' }" [header]="tituloDialog" [modal]="true">
        <div class="flex flex-col gap-6">
            <div>
                <label for="nombre" class="block font-bold mb-3">Nombre</label>
                <input type="text" pInputText id="nombre" [(ngModel)]="actividad.nombre" autofocus class="w-full" placeholder="Introduzca el Nombre de la Actividad" />
                <small class="text-red-500" *ngIf="submitted && !actividad.nombre">El nombre es requerido.</small>
            </div>
            <div class="col-span-6">
                <label for="descripcion" class="block font-bold mb-3">Descripción</label>
                <input type="text" pInputText id="descripcion" [(ngModel)]="actividad.descripcion" class="w-full" placeholder="Descripción de la actividad" />
                <small class="text-red-500" *ngIf="submitted && !actividad.descripcion">La descripción es requerida.</small>
            </div>
            <div>
                <label for="incentivos" class="block font-bold mb-3">Incentivos</label>
                <p-multiSelect [options]="disponibleIncentivos" [(ngModel)]="selectedIncentivos" optionLabel="nombre" optionValue="id" [filter]="true" placeholder="Seleccione los incentivos" display="chip" [style]="{ width: '100%' }" appendTo="body">
                </p-multiSelect>
            </div>

            <div *ngIf="actividad.incentivos && actividad.incentivos.length > 0">
                <label class="block font-bold mb-3">Incentivos Asociados</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div *ngFor="let inc of actividad.incentivos" class="flex items-center p-3 surface-card shadow-1 border-round">
                        <img *ngIf="inc.imagenBase64" [src]="inc.imagenBase64" [alt]="inc.nombre" class="w-8 h-8 mr-3 border-round shadow-1" />
                        <div>
                            <div class="font-medium">{{ inc.nombre }}</div>
                            <div class="text-sm text-color-secondary">{{ inc.descripcion }}</div>
                            <div class="text-xs mt-1 font-bold">Cantidad: {{ inc.cantidad }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div *ngIf="actividad.id" class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block font-bold mb-1">Fecha de Creación</label>
                    <div class="text-color-secondary">{{ actividad.fecha | date: 'dd/MM/yyyy' }}</div>
                </div>
                <div>
                    <label class="block font-bold mb-1">Hora de Creación</label>
                    <div class="text-color-secondary">{{ actividad.hora }}</div>
                </div>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <p-button label="Cancelar" icon="pi pi-times" styleClass="p-button-text" (click)="hideDialog()"></p-button>
            <p-button *ngIf="actividad.id" label="Actualizar" icon="pi pi-check" (click)="updateActividad()"></p-button>
            <p-button *ngIf="!actividad.id" label="Guardar" icon="pi pi-check" (click)="saveActividad()"></p-button>
        </ng-template>
    </p-dialog>
    <p-confirmdialog [style]="{ width: '450px' }" />
</div>
