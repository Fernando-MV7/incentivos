<div *ngIf="!isAuthorized" class="flex justify-center items-start mt-8">
    <div class="surface-card border-round shadow-3 p-6 text-center w-full max-w-md">
        <div class="mb-4">
            <i class="pi pi-lock text-6xl text-primary-500" style="font-size: 4em"></i>
        </div>
        <h2 class="text-4xl font-bold text-primary-700 mb-3" style="font-weight: 900">Acceso restringido</h2>
        <p class="text-sm text-color-secondary mb-4">No cuentas con los permisos necesarios para acceder a esta secci贸n del sistema.</p>
    </div>
</div>

<div *ngIf="isAuthorized">
    <p-toast></p-toast>
    <p-toolbar styleClass="mb-6">
        <ng-template #start>
            <p-button label="Nuevo Incentivo" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
            <p-button severity="secondary" label="Eliminar" icon="pi pi-trash" outlined (onClick)="deleteSelectedIncentivos()" [disabled]="!selectedIncentivos || !selectedIncentivos.length" />
        </ng-template>
    </p-toolbar>

    <p-table
        #dt
        [value]="incentivos()"
        [rows]="10"
        [columns]="cols"
        [paginator]="true"
        [globalFilterFields]="['id', 'nombre', 'descripcion', 'cantidad', 'imagen', 'estado']"
        [tableStyle]="{ 'min-width': '75rem' }"
        [(selection)]="selectedIncentivos"
        [rowHover]="true"
        dataKey="id"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} incentivos"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 20, 30]"
    >
        <ng-template #caption>
            <div class="flex items-center justify-between">
                <h5 class="m-0">Incentivos Registrados</h5>
                <p-iconfield>
                    <p-inputicon styleClass="pi pi-search" />
                    <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar por nombre..." />
                </p-iconfield>
            </div>
        </ng-template>

        <ng-template #header>
            <tr>
                <th style="width: 3rem">
                    <p-tableHeaderCheckbox />
                </th>
                <th style="width: 5rem">ID</th>
                <th pSortableColumn="nombre" style="min-width: 12rem">
                    NOMBRE
                    <p-sortIcon field="nombre" />
                </th>
                <th pSortableColumn="descripcion" style="min-width: 12rem">
                    DESCRIPCION
                </th>
                <th pSortableColumn="cantidad" style="min-width: 8rem">
                    CANTIDAD
                    <p-sortIcon field="cantidad" />
                </th>
                <th style="min-width: 10rem">IMAGEN</th>
                <th pSortableColumn="estado" style="min-width: 8rem">
                    ESTADO
                    <p-sortIcon field="estado" />
                </th>
                <th style="min-width: 10rem">ACCIONES</th>
            </tr>
        </ng-template>

        <ng-template #body let-incentivo>
            <tr>
                <td style="width: 3rem">
                    <p-tableCheckbox [value]="incentivo" />
                </td>
                <td>{{ incentivo.id }}</td>
                <td>{{ incentivo.nombre }}</td>
                <td>{{ incentivo.descripcion }}</td>
                <td>{{ incentivo.cantidad }}</td>
                <td>
                    <img *ngIf="incentivo.imagenBase64" [src]="incentivo.imagenBase64" alt="Incentivo Imagen" class="w-8 h-8 shadow-2 border-round" style="object-fit: cover; max-width: 80px; max-height: 80px" />
                    <span *ngIf="!incentivo.imagenBase64" class="text-sm text-gray-400">Sin imagen</span>
                </td>
                <td>
                    <p-tag [value]="incentivo.estado ? 'Disponible' : 'No disponible'" [icon]="incentivo.estado ? 'pi pi-check-circle' : 'pi pi-times-circle'" [severity]="incentivo.estado ? 'success' : 'danger'"> </p-tag>
                </td>
                <td>
                    <p-button icon="pi pi-pen-to-square" class="mr-2" [rounded]="true" [outlined]="true" (click)="editIncentivo(incentivo)" />
                    <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (click)="deleteIncentivo(incentivo)" />
                </td>
            </tr>
        </ng-template>
    </p-table>

    <p-dialog [(visible)]="incentivoDialog" [style]="{ width: '550px' }" [header]="tituloDialog" [modal]="true">
        <div class="flex flex-col gap-6">
            <div *ngIf="incentivo.id && incentivo.imagen" style="display: flex; justify-content: center; align-items: center; min-height: 150px">
                <img [src]="incentivo.imagen" alt="Imagen del incentivo" class="shadow-2 border-round" style="object-fit: cover; max-width: 280px; max-height: 230px" />
            </div>
            <div>
                <label for="nombre" class="block font-bold mb-3">Nombre</label>
                <input type="text" pInputText id="nombre" [(ngModel)]="incentivo.nombre" autofocus class="w-full" placeholder="Introduzca el Nombre del incentivo" />
                <small class="text-red-500" *ngIf="submitted && !incentivo.nombre">El nombre es requerido.</small>
            </div>
            <div class="grid grid-cols-12 gap-4">
                <div class="col-span-6">
                    <label for="descripcion" class="block font-bold mb-3">Descripci贸n</label>
                    <input type="text" pInputText id="descripcion" [(ngModel)]="incentivo.descripcion" class="w-full" placeholder="Descripci贸n del Incentivo" />
                    <small class="text-red-500" *ngIf="submitted && !incentivo.descripcion">La descripci贸n es requerida.</small>
                </div>
                <div class="col-span-6">
                    <label for="cantidad" class="block font-bold mb-3">Cantidad</label>
                    <input type="number" pInputText id="cantidad" [(ngModel)]="incentivo.cantidad" class="w-full" placeholder="Cantidad de Incentivo" />
                    <small class="text-red-500" *ngIf="submitted && (incentivo.cantidad === undefined || incentivo.cantidad === null)">La cantidad es requerida.</small>
                </div>
            </div>
            <div>
                <label for="fileInput" class="block font-bold mb-3">Imagen</label>
                <div *ngIf="incentivo.id">
                    <p-message severity="info" text="Selecciona la imagen solo si desea actualizarlo."> </p-message>
                </div>
                <div class="flex flex-col gap-1">
                    <input type="file" #fileInput accept="image/*" (change)="onFileSelect($event)" class="w-full p-2 border-round border-1 surface-border" />

                    <div *ngIf="selectedImageURL || incentivo.imagen; else noImage" style="display: flex; justify-content: center; align-items: center; min-height: 150px">
                        <img [src]="selectedImageURL || incentivo.imagen" alt="Vista previa de imagen" class="shadow-2 border-round" style="object-fit: cover; max-width: 200px; max-height: 150px" />
                    </div>

                    <ng-template #noImage>
                        <p class="text-sm text-gray-400 text-center">No se ha seleccionado ninguna imagen.</p>
                    </ng-template>

                    <small class="text-red-500" *ngIf="submitted && !selectedFile && !incentivo.imagen">La imagen es requerida.</small>
                </div>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <p-button label="Cancelar" icon="pi pi-times" styleClass="p-button-text" (click)="hideDialog()"></p-button>
            <p-button *ngIf="incentivo.id" label="Actualizar" icon="pi pi-check" (click)="updateIncentivo()"></p-button>
            <p-button *ngIf="!incentivo.id" label="Guardar" icon="pi pi-check" (click)="saveIncentivo()"></p-button>
        </ng-template>
    </p-dialog>

    <p-confirmdialog [style]="{ width: '450px' }" />
</div>
