<div *ngIf="!isAuthorized" class="flex justify-center items-start mt-8">
    <div class="surface-card border-round shadow-3 p-6 text-center w-full max-w-md">
        <div class="mb-4">
            <i class="pi pi-lock text-6xl text-primary-500" style="font-size: 4em"></i>
        </div>
        <h2 class="text-4xl font-bold text-primary-700 mb-3" style="font-weight: 900">Acceso restringido</h2>
        <p class="text-sm text-color-secondary mb-4">No cuentas con los permisos necesarios para acceder a esta sección del sistema.</p>
    </div>
</div>
<div *ngIf="isAuthorized" class="font-sans">
    <p-toast></p-toast>
    <p-confirmDialog [style]="{ width: '450px' }" header="Confirmación" icon="pi pi-exclamation-triangle"></p-confirmDialog>
    <div class="grid grid-cols-1 gap-4">
        <div class="grid grid-cols-1 gap-4">
            <p-card>
                <ng-template pTemplate="title">
                    <h2 class="text-primary flex justify-center">SOCIOS HABILITADOS</h2>
                </ng-template>

                <div class="mb-5">
                    <div class="text-primary font-bold mb-1">Actividad:</div>
                    <p-select
                        *ngIf="actividadesHabilitadas.length > 1"
                        [options]="actividadesHabilitadas"
                        [(ngModel)]="actividadSeleccionada"
                        optionLabel="nombre"
                        (onChange)="onActividadChange($event)"
                        placeholder="Seleccione una actividad"
                        [style]="{ width: '100%' }"
                        appendTo="body"
                    >
                    </p-select>

                    <input *ngIf="actividadesHabilitadas.length <= 1" pInputText [value]="actividadSeleccionada?.nombre" class="w-full mt-2" readonly />
                </div>

                <div class="mb-4">
                    <div class="flex flex-wrap gap-2 md:gap-3 items-center">
                        <p-fileUpload name="archivo" accept=".xls,.xlsx" mode="basic" [auto]="true" (onSelect)="onFileSelect($event)" chooseLabel="Seleccionar Archivo" styleClass="w-full md:w-auto" />

                        <input type="text" pInputText [(ngModel)]="busquedaNumeroSocio" placeholder="Ingrese número de socio" class="w-full md:flex-1 mr-0 md:mr-2" />

                        <button pButton type="button" icon="pi pi-search" label="Buscar" (click)="buscarSocio()" class="w-full md:w-auto"></button>
                    </div>
                </div>

                <div *ngIf="mostrarVistaPrevia" class="overflow-x-auto mb-4 border-1 border-solid border-gray-300 rounded-md">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr>
                                <th *ngFor="let header of excelData[0]" class="font-bold text-center">{{ header }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let row of excelData.slice(1)">
                                <td *ngFor="let cell of row" class="text-center">{{ cell }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mb-4 flex justify-center" *ngIf="mostrarVistaPrevia">
                    <button pButton type="button" label="Cargar Archivo" (click)="onUpload()" [disabled]="cargando" class="p-button-primary"></button>
                    <button pButton type="button" icon="pi pi-times" label="Cancelar" (click)="cancelarArchivoSeleccionado()" class="p-button-outlined ml-2"></button>
                </div>
                <div class="flex flex-wrap gap-2 mt-4 justify-center">
                    <button pButton type="button" icon="pi pi-plus" label="Agregar Socio" (click)="abrirFormularioNuevoSocio()" class="text-primary"></button>
                    <button
                        pButton
                        type="button"
                        icon="pi pi-trash"
                        label="Eliminar Seleccionados"
                        (click)="confirmarEliminarMultiples()"
                        [disabled]="!sociosSeleccionados || sociosSeleccionados.length === 0"
                        class="p-button-outlined p-button-danger"
                    ></button>
                </div>
            </p-card>
        </div>

        <p-card>
            <ng-template pTemplate="title">
                <div class="mb-4">
                    <div class="text-primary mb-1" style="font-size: medium">Filtrar por actividad:</div>
                    <div class="flex gap-2">
                        <p-select
                            [options]="opcionesActividades"
                            [(ngModel)]="selectedActividadId"
                            (onChange)="onActividadDropdownChange($event)"
                            placeholder="Selecciona una actividad para filtrar"
                            optionLabel="label"
                            optionValue="value"
                            [showClear]="true"
                            class="font-normal text-sm"
                        >
                        </p-select>
                        <button pButton type="button" icon="pi pi-users" label="Listar todos" (click)="cargarSocios()" class="p-button-outlined text-primary"></button>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <div class="text-primary">
                        <i class="pi pi-pw pi-users text-xl mr-2"></i>
                        <span class="font-medium">Lista de Socios</span>
                    </div>
                    <div class="text-sm text-primary border border-primary rounded px-2 py-1">Total: {{ socios.length }} socios</div>
                </div>
            </ng-template>
            <p-table
                [value]="socios"
                [paginator]="true"
                [rows]="10"
                [rowsPerPageOptions]="[5, 10, 25, 50]"
                [loading]="cargando"
                styleClass="p-datatable-sm p-datatable-gridlines"
                [resizableColumns]="true"
                [autoLayout]="true"
                [(selection)]="sociosSeleccionados"
                (selectionChange)="onSeleccionSociosChange($event)"
            >
                <ng-template pTemplate="header">
                    <tr class="bg-gray-50">
                        <th style="width: 5%">
                            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                        </th>
                        <th style="width: 10%">N° Socio</th>
                        <th style="width: 20%">Nombre</th>
                        <th style="width: 10%">Habilitado</th>
                        <th style="width: 10%; text-align: center">Entregado</th>
                        <th style="width: 10%; text-align: center">Id Actividad</th>
                        <th style="width: 15%; text-align: center">Acciones</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-socio>
                    <tr>
                        <td>
                            <p-tableCheckbox [value]="socio"></p-tableCheckbox>
                        </td>
                        <td>
                            <strong class="font-semibold">{{ socio.numeroSocio }}</strong>
                        </td>
                        <td>{{ socio.nombres }}</td>
                        <td>
                            <ng-container *ngIf="socio.habilitado; else inhabilitado">
                                <span class="gap-1 text-green-500 font-medium text-sm cursor-pointer hover:underline flex items-center" (click)="deshabilitarSocio(socio)"> <i class="pi pi-check-circle mr-1"></i> Habilitado </span>
                            </ng-container>

                            <ng-template #inhabilitado>
                                <span class="gap-1 text-red-500 font-medium text-sm cursor-pointer hover:underline flex items-center" (click)="habilitarSocio(socio)"> <i class="pi pi-times-circle mr-1"></i> Inhabilitado </span>
                            </ng-template>
                        </td>
                        <td style="text-align: center">
                            <span *ngIf="socio.entregado; else noEntregado" class="gap-1 text-green-500 font-medium text-sm"> <i class="pi pi-send"></i> SI </span>
                            <ng-template #noEntregado>
                                <span class="gap-1 text-red-500 font-medium text-sm"> <i class="pi pi-times-circle"></i> NO </span>
                            </ng-template>
                        </td>
                        <td style="text-align: center">{{ socio.idActividad }}</td>
                        <td>
                            <div class="flex gap-2" style="justify-content: center">
                                <button pButton type="button" icon="pi pi-trash" class="p-button-outlined p-button-danger p-button-sm" pTooltip="Eliminar" tooltipPosition="top" (click)="eliminarSocio(socio)"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="7" class="text-center py-4">No se encontraron socios</td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="summary">
                    <div class="flex justify-between items-center">
                        <div>{{ sociosSeleccionados.length }} socios seleccionados</div>
                    </div>
                </ng-template>
            </p-table>
        </p-card>

        <p-dialog header="Detalle del Socio" [(visible)]="mostrarDialogoDetalle" [modal]="true" [style]="{ width: '450px' }" [draggable]="false" [resizable]="false">
            <div *ngIf="socioDetalle" class="grid grid-cols-1 gap-4 mb-4">
                <div class="mb-2">
                    <label class="block mb-1 font-bold">N° Socio:</label>
                    <div class="text-lg">{{ socioDetalle.numeroSocio }}</div>
                </div>
                <div class="mb-2">
                    <label class="block mb-1 font-bold">Nombre:</label>
                    <div class="text-lg">{{ socioDetalle.nombres }}</div>
                </div>
                <div class="mb-2">
                    <label class="block mb-1 font-bold">Estado:</label>
                    <div class="text-lg">
                        <span *ngIf="socioDetalle.habilitado" class="text-green-500"> <i class="pi pi-check-circle mr-1"></i>Habilitado </span>
                        <span *ngIf="!socioDetalle.habilitado" class="text-red-500"> <i class="pi pi-times-circle mr-1"></i>Inhabilitado </span>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="block mb-1 font-bold">Entregado:</label>
                    <div class="text-lg">
                        <span *ngIf="socioDetalle.entregado" class="text-green-500"> <i class="pi pi-check-circle mr-1"></i>SI </span>
                        <span *ngIf="!socioDetalle.entregado" class="text-red-500"> <i class="pi pi-times-circle mr-1"></i>NO </span>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="block mb-1 font-bold">Actividad:</label>
                    <div class="text-lg">{{ actividadSeleccionada?.nombre }}</div>
                </div>
            </div>
            <ng-template pTemplate="footer">
                <div class="flex justify-between w-full">
                    <div>
                        <button pButton *ngIf="socioDetalle && !socioDetalle.habilitado" type="button" icon="pi pi-check" label="Habilitar" class="text-primary mr-2" (click)="habilitarSocio(socioDetalle); mostrarDialogoDetalle = false"></button>
                        <button
                            pButton
                            *ngIf="socioDetalle && socioDetalle.habilitado"
                            type="button"
                            icon="pi pi-ban"
                            label="Deshabilitar"
                            class="p-button-outlined p-button-danger mr-2"
                            (click)="deshabilitarSocio(socioDetalle); mostrarDialogoDetalle = false"
                        ></button>
                    </div>
                    <div>
                        <button pButton type="button" icon="pi pi-trash" label="Eliminar" class="p-button-outlined p-button-danger mr-2" (click)="eliminarSocio(socioDetalle); mostrarDialogoDetalle = false"></button>
                        <button pButton type="button" icon="pi pi-times" label="Cerrar" class="p-button-outlined" (click)="mostrarDialogoDetalle = false"></button>
                    </div>
                </div>
            </ng-template>
        </p-dialog>

        <p-dialog header="Registrar Socio" [(visible)]="mostrarFormularioNuevoSocio" [modal]="true" [style]="{ width: '450px' }" [draggable]="false" [resizable]="false">
            <div class="grid grid-cols-1 gap-4 mb-4">
                <div class="mb-2">
                    <label class="block mb-1 font-bold">N° Socio</label>
                    <input type="text" pInputText [(ngModel)]="nuevoSocio.numeroSocio" class="w-full" placeholder="Ingrese número de socio" required />
                </div>

                <div class="mb-2">
                    <label class="block mb-1 font-bold">Nombre</label>
                    <input type="text" pInputText [(ngModel)]="nuevoSocio.nombres" class="w-full" placeholder="Ingrese nombres completos" required />
                </div>
                <div class="mb-2">
                    <label class="block mb-1 font-bold">Actividad</label>
                    <input *ngIf="actividadSeleccionada" type="text" pInputText [value]="actividadSeleccionada.nombre" class="w-full" readonly />
                    <p *ngIf="!actividadSeleccionada" class="text-red-500">Debe seleccionar una actividad primero</p>
                </div>

                <div class="mb-2 flex items-center">
                    <p-checkbox [(ngModel)]="nuevoSocio.habilitado" [binary]="true"></p-checkbox>
                    <label class="ml-2">Habilitado</label>
                </div>
            </div>

            <ng-template pTemplate="footer">
                <p-button label="Cancelar" icon="pi pi-times" styleClass="p-button-text" (click)="cancelarNuevoSocio()"></p-button>
                <p-button label="Guardar" icon="pi pi-check" (click)="guardarNuevoSocio()"></p-button>
            </ng-template>
        </p-dialog>

        <p-dialog header="Confirmar Eliminación" [(visible)]="mostrarDialogoConfirmacionMultiple" [modal]="true" [style]="{ width: '450px' }" [draggable]="false" [resizable]="false">
            <div class="py-4">
                <div class="flex items-center justify-center mb-4 text-orange-500">
                    <i class="pi pi-exclamation-triangle text-5xl"></i>
                </div>
                <p class="text-center text-lg mb-2">¿Está seguro que desea eliminar los socios seleccionados?</p>
                <p class="text-center text-gray-600">
                    Esta acción no se puede deshacer y eliminará <strong>{{ sociosSeleccionados.length || 0 }}</strong> socios.
                </p>
            </div>

            <ng-template pTemplate="footer">
                <div class="flex justify-end gap-2">
                    <p-button label="Cancelar" icon="pi pi-times" styleClass="p-button-text" (click)="cancelarEliminacionMultiple()"> </p-button>
                    <p-button label="Eliminar" icon="pi pi-trash" styleClass="p-button-danger" (click)="eliminarMultiplesSocios()"> </p-button>
                </div>
            </ng-template>
        </p-dialog>
    </div>
</div>
